import{j as e}from"./vendor-ui-c5075e48.js";import{r as s}from"./vendor-react-c35372bd.js";import{C as t,a,b as i,c as r}from"./card-b68930bc.js";import{u as n,s as l,B as c,I as d,T as o,t as m}from"./index-67d0fb94.js";import{S as u,a as x,b as f,c as h,d as p}from"./select-1d5620de.js";import{D as j,e as v,a as g,b as _,c as N}from"./dialog-aab7369c.js";import{b3 as y,a3 as w,m as b,U as S,aj as C,C as D,h as E}from"./vendor-utils-7072100e.js";import"./vendor-editor-d6577754.js";const k=()=>{var k,P;const{userProfile:q}=n(),[F,I]=s.useState([]),[L,T]=s.useState(null),[z,B]=s.useState([]),[K,M]=s.useState(""),[O,V]=s.useState(!1),[G,H]=s.useState([]),[R,U]=s.useState(!1),[Y,A]=s.useState(""),[J,Q]=s.useState(""),W=s.useRef(null);s.useEffect(()=>{(null==q?void 0:q.id)&&($(),Z())},[null==q?void 0:q.id]),s.useEffect(()=>{L&&(ee(),se())},[L]),s.useEffect(()=>{X()},[z]);const X=()=>{var e;null==(e=W.current)||e.scrollIntoView({behavior:"smooth"})},Z=async()=>{try{const{data:e}=await l.from("user_profiles").select("id, full_name, email, profile_picture_url").in("role",["nutritionist","admin","super_admin"]).order("full_name");H(e||[])}catch(e){}},$=async()=>{try{const{data:e}=await l.from("conversations").select("\n          *,\n          nutritionist:nutritionist_id (\n            id,\n            full_name,\n            email,\n            profile_picture_url\n          )\n        ").eq("user_id",q.id).order("last_message_at",{ascending:!1});I(e||[])}catch(e){}},ee=async()=>{try{const{data:e}=await l.from("conversation_messages").select("\n          *,\n          sender:sender_id (\n            id,\n            full_name,\n            profile_picture_url\n          )\n        ").eq("conversation_id",L.id).order("created_at",{ascending:!0});B(e||[])}catch(e){}},se=async()=>{try{await l.rpc("mark_conversation_read",{p_conversation_id:L.id,p_user_id:q.id}),$()}catch(e){}},te=async()=>{if(K.trim()){V(!0);try{const{error:e}=await l.from("conversation_messages").insert({conversation_id:L.id,sender_id:q.id,sender_role:"user",message_text:K});if(e)throw e;M(""),ee(),$(),m({title:"Message sent",description:"Your message has been sent successfully"})}catch(e){m({title:"Error",description:"Failed to send message",variant:"destructive"})}finally{V(!1)}}};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs(t,{className:"glass-effect lg:col-span-1",children:[e.jsx(a,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(i,{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(y,{className:"w-5 h-5"}),"Messages"]}),e.jsxs(j,{open:R,onOpenChange:U,children:[e.jsx(v,{asChild:!0,children:e.jsxs(c,{size:"sm",children:[e.jsx(w,{className:"w-4 h-4 mr-1"}),"New"]})}),e.jsxs(g,{children:[e.jsx(_,{children:e.jsx(N,{children:"Start New Conversation"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Professional"}),e.jsxs(u,{value:Y,onValueChange:A,children:[e.jsx(x,{children:e.jsx(f,{placeholder:"Choose a nutritionist or admin"})}),e.jsx(h,{children:G.map(s=>e.jsxs(p,{value:s.id,children:[s.full_name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Subject (Optional)"}),e.jsx(d,{value:J,onChange:e=>Q(e.target.value),placeholder:"e.g., Diet plan question"})]}),e.jsx(c,{onClick:async()=>{if(Y){V(!0);try{const{data:e,error:s}=await l.from("conversations").insert({user_id:q.id,nutritionist_id:Y,subject:J||"General Inquiry"}).select().single();if(s)throw s;U(!1),A(""),Q(""),$(),m({title:"Success",description:"Conversation created successfully"})}catch(e){m({title:"Error",description:"Failed to create conversation",variant:"destructive"})}finally{V(!1)}}else m({title:"Error",description:"Please select a nutritionist",variant:"destructive"})},disabled:O,className:"w-full",children:"Start Conversation"})]})]})]})]})}),e.jsx(r,{className:"p-0",children:e.jsx("div",{className:"divide-y max-h-[calc(100vh-300px)] overflow-y-auto",children:0===F.length?e.jsxs("div",{className:"p-8 text-center text-muted-foreground",children:[e.jsx(y,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start a new conversation to get help from our nutritionists"})]}):F.map(s=>{var t,a;return e.jsx(b.div,{initial:{opacity:0},animate:{opacity:1},className:"p-4 cursor-pointer hover:bg-muted/50 transition-colors "+((null==L?void 0:L.id)===s.id?"bg-muted":""),onClick:()=>T(s),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0",children:(null==(t=s.nutritionist)?void 0:t.profile_picture_url)?e.jsx("img",{src:s.nutritionist.profile_picture_url,alt:s.nutritionist.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(S,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold truncate",children:null==(a=s.nutritionist)?void 0:a.full_name}),s.unread_by_user>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s.unread_by_user})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mt-1",children:s.last_message_preview||"No messages yet"}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-1",children:[e.jsx(C,{className:"w-3 h-3"}),s.last_message_at?new Date(s.last_message_at).toLocaleDateString():new Date(s.created_at).toLocaleDateString()]})]})]})},s.id)})})})]}),e.jsx(t,{className:"glass-effect lg:col-span-2 flex flex-col",children:L?e.jsxs(e.Fragment,{children:[e.jsx(a,{className:"pb-3 border-b",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:(null==(k=L.nutritionist)?void 0:k.profile_picture_url)?e.jsx("img",{src:L.nutritionist.profile_picture_url,alt:L.nutritionist.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(S,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:null==(P=L.nutritionist)?void 0:P.full_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:L.subject})]})]})}),e.jsxs(r,{className:"flex-1 overflow-y-auto p-4 space-y-4 max-h-[calc(100vh-450px)]",children:[z.map(s=>e.jsx(b.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex "+(s.sender_id===q.id?"justify-end":"justify-start"),children:e.jsxs("div",{className:"max-w-[70%] rounded-lg p-3 "+(s.sender_id===q.id?"bg-primary text-primary-foreground":"bg-muted"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message_text}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-xs "+(s.sender_id===q.id?"text-primary-foreground/70":"text-muted-foreground"),children:[new Date(s.created_at).toLocaleTimeString(),s.sender_id===q.id&&s.is_read&&e.jsx(D,{className:"w-3 h-3 ml-1"})]})]})},s.id)),e.jsx("div",{ref:W})]}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{value:K,onChange:e=>M(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),te())},placeholder:"Type your message... (Press Enter to send)",rows:2,className:"flex-1"}),e.jsx(c,{onClick:te,disabled:O||!K.trim(),size:"icon",className:"self-end",children:e.jsx(E,{className:"w-4 h-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"Select a conversation to start messaging"}),e.jsx("p",{className:"text-sm mt-2",children:"or create a new conversation to get started"})]})})})]})};export{k as default};
