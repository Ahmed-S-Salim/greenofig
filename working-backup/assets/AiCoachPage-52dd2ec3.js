import{j as e}from"./vendor-ui-8934955f.js";import{r as s}from"./vendor-react-c35372bd.js";import{a,g as t,s as r,H as i,T as n,B as l}from"./index-05934966.js";import{m as o,L as d,b as c,q as m,U as u,h}from"./vendor-utils-1c9b7ece.js";import"./vendor-editor-7586347a.js";const x=()=>{const{userProfile:x,user:f}=a(),{toast:y}=t(),[p,g]=s.useState([]),[j,v]=s.useState(""),[w,b]=s.useState(!1),[N,k]=s.useState(!0),_=s.useRef(null);s.useEffect(()=>{var e;null==(e=_.current)||e.scrollIntoView({behavior:"smooth"})},[p]);const I=s.useCallback(async()=>{var e;if(f)try{k(!0);const{data:s,error:a}=await r.from("ai_chat_messages").select("id, text, sender, created_at").eq("user_id",f.id).order("created_at",{ascending:!0});if(a)throw a;if(s&&s.length>0)g(s);else if(x){const s={id:Date.now(),text:`Hello ${(null==(e=null==x?void 0:x.full_name)?void 0:e.split(" ")[0])||"there"}! I'm your personal AI Health Coach. How can I help you achieve your wellness goals today?`,sender:"ai"};g([s])}}catch(s){y({variant:"destructive",title:"Error fetching history",description:"Could not load your previous conversation."})}finally{k(!1)}},[f,x,y]);s.useEffect(()=>{I()},[I]);const S=async(e,s)=>{e&&e.preventDefault();const a=s||j;if(!a.trim()||w)return;const t={text:a,sender:"user",user_id:f.id},i={...t,id:Date.now(),created_at:(new Date).toISOString()},n=[...p,i];g(n),v(""),b(!0),await r.from("ai_chat_messages").insert(t);try{const{data:e,error:s}=await r.functions.invoke("ai-coach-memory",{body:JSON.stringify({messages:n.slice(-10),userProfile:x})});if(s)throw s;const a={text:e.reply,sender:"ai",user_id:f.id},{data:t,error:l}=await r.from("ai_chat_messages").insert(a).select().single();if(l)throw l;g(e=>[...e.filter(e=>e.id!==i.id),i,t])}catch(l){const e={id:Date.now()+1,text:"Sorry, I'm having trouble connecting right now. Please try again in a moment.",sender:"ai"};g(s=>[...s,e])}finally{b(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(i,{children:[e.jsx("title",{children:"AI Coach - GreenoFig"}),e.jsx("meta",{name:"description",content:"Chat with your personal AI health and wellness coach."})]}),e.jsxs(o.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col h-[calc(100vh-120px)]",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 space-y-6",children:[N&&e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(d,{className:"w-8 h-8 animate-spin text-primary"})}),e.jsx(c,{children:!N&&p.map(s=>e.jsxs(o.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"flex items-end gap-3 "+("user"===s.sender?"justify-end":"justify-start"),children:["ai"===s.sender&&e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(m,{className:"w-6 h-6 text-primary"})}),e.jsx("div",{className:"max-w-lg p-4 rounded-2xl shadow-md "+("user"===s.sender?"bg-primary text-primary-foreground rounded-br-none":"bg-muted text-foreground rounded-bl-none"),children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.text})}),"user"===s.sender&&e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-muted flex items-center justify-center",children:e.jsx(u,{className:"w-5 h-5 text-muted-foreground"})})]},s.id))}),w&&e.jsxs(o.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-end gap-3 justify-start",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(m,{className:"w-6 h-6 text-primary"})}),e.jsx("div",{className:"max-w-lg p-4 rounded-2xl shadow-md bg-muted text-foreground rounded-bl-none",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{className:"text-sm",children:"Thinking..."})]})})]}),e.jsx("div",{ref:_})]}),p.length<=1&&!w&&!N&&e.jsx("div",{className:"p-4 md:px-6",children:e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["Give me a healthy breakfast idea.","Suggest a quick 15-minute workout.","How can I increase my energy levels?","What's a good way to de-stress?"].map((s,a)=>e.jsx(o.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1*a},onClick:e=>S(e,s),className:"p-3 bg-muted hover:bg-accent rounded-lg text-left text-sm",children:s},a))})}),e.jsx("div",{className:"p-4 md:p-6 border-t border-border bg-background",children:e.jsxs("form",{onSubmit:S,className:"relative",children:[e.jsx(n,{value:j,onChange:e=>v(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||S(e)},placeholder:"Ask your AI coach anything...",className:"w-full pr-20 py-3 resize-none bg-muted border-border",rows:1,disabled:w||N}),e.jsx(l,{type:"submit",size:"icon",className:"absolute right-3 top-1/2 -translate-y-1/2",disabled:w||N||!j.trim(),children:e.jsx(h,{className:"w-5 h-5"})})]})})]})]})};export{x as default};
