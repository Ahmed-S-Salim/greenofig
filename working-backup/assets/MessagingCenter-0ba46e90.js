import{j as e}from"./vendor-ui-8934955f.js";import{l as s,r}from"./vendor-react-c35372bd.js";import{C as a,a as t,b as i,c as n}from"./card-5ef2c077.js";import{a as l,s as d,b as c,B as o,I as m,T as u,t as x}from"./index-05934966.js";import{D as p,a as h,b as f,c as j,f as g}from"./dialog-f70f7e7c.js";import{L as v,be as N,au as _,ao as w,U as b,i as y,A as C,C as A,h as S}from"./vendor-utils-1c9b7ece.js";import"./vendor-editor-7586347a.js";const E=()=>{var E,k,I;const{userProfile:M}=l(),[B]=s(),[q,F]=r.useState([]),[L,z]=r.useState(null),[R,U]=r.useState([]),[$,D]=r.useState(""),[Q,T]=r.useState(!1),[G,H]=r.useState(!1),[J,P]=r.useState([]),[O,V]=r.useState(!1),[X,Y]=r.useState(""),[Z,K]=r.useState(""),[W,ee]=r.useState(""),se=r.useRef(null),[re]=r.useState(new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuEzvLaizsIGmi77eamUBELTKXh8bllHAU2jdXyzn0vBSR2xe/glEILElyx6OyrWBQLRp3e8cFuJAUpgs/z3I4+CRhnvO7op1YSCEE="));r.useEffect(()=>{if(null==M?void 0:M.id){ne(),ie();const e=d.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`recipient_id=eq.${M.id}`},e=>{re.play().catch(e=>{}),ne(),L&&e.new.sender_id===L.partnerId&&de(L)}).subscribe();return()=>{d.removeChannel(e)}}},[null==M?void 0:M.id,L]);const ae=r.useRef(!1);r.useEffect(()=>{const e=B.get("conversation");if(e&&q.length>0&&!ae.current){const s=q.find(s=>s.partnerId===e);s&&(ae.current=!0,z(s),ce(s),de(s))}},[q.length,B]),r.useEffect(()=>{te()},[R]);const te=()=>{var e;null==(e=se.current)||e.scrollIntoView({behavior:"smooth"})},ie=async()=>{try{const{data:e}=await d.from("user_profiles").select("id, full_name, email, profile_picture_url").eq("role","nutritionist").order("full_name");P(e||[])}catch(e){}},ne=async()=>{T(!0);try{const{data:e,error:s}=await d.from("messages").select("*").or(`sender_id.eq.${M.id},recipient_id.eq.${M.id}`).order("created_at",{ascending:!1});if(s)return F([]),void T(!1);if(e&&e.length>0){const s=new Set;e.forEach(e=>{e.sender_id&&s.add(e.sender_id),e.recipient_id&&s.add(e.recipient_id)});const{data:r}=await d.from("user_profiles").select("id, full_name, email, profile_picture_url").in("id",Array.from(s));if(r){const s=new Map(r.map(e=>[e.id,e])),a=e.map(e=>({...e,sender:s.get(e.sender_id),recipient:s.get(e.recipient_id)}));le(a)}else le(e)}else F([]),T(!1)}catch(e){F([]),T(!1)}},le=e=>{try{const s=new Map;(e||[]).forEach(e=>{const r=e.sender_id===M.id?e.recipient_id:e.sender_id,a=e.sender_id===M.id?e.recipient:e.sender;s.has(r)||s.set(r,{partnerId:r,partner:a,lastMessage:e,unreadCount:0}),e.recipient_id!==M.id||e.is_read||s.get(r).unreadCount++}),F(Array.from(s.values()))}catch(s){F([])}finally{T(!1)}},de=async e=>{try{const s=e.partnerId,{data:r,error:a}=await d.from("messages").select("*").or(`and(sender_id.eq.${M.id},recipient_id.eq.${s}),and(sender_id.eq.${s},recipient_id.eq.${M.id})`).order("created_at",{ascending:!0});if(a)return void U([]);if(r&&r.length>0){const e=new Set([M.id,s]),{data:a}=await d.from("user_profiles").select("id, full_name, email, profile_picture_url").in("id",Array.from(e));if(a){const e=new Map(a.map(e=>[e.id,e])),s=r.map(s=>({...s,sender:e.get(s.sender_id),recipient:e.get(s.recipient_id)}));U(s)}else U(r)}else U([])}catch(s){U([])}},ce=async e=>{try{const{error:s}=await d.from("messages").update({is_read:!0}).eq("sender_id",e.partnerId).eq("recipient_id",M.id).eq("is_read",!1);s||ne()}catch(s){}},oe=async()=>{if($.trim()&&L){H(!0);try{const{error:e}=await d.from("messages").insert({sender_id:M.id,recipient_id:L.partnerId,message_text:$.trim(),is_read:!1});if(e)throw e;D(""),await de(L),await ne()}catch(e){x({title:"Error",description:"Failed to send message",variant:"destructive"})}finally{H(!1)}}},me=q.filter(e=>{var s,r,a,t;return(null==(r=null==(s=e.partner)?void 0:s.full_name)?void 0:r.toLowerCase().includes(W.toLowerCase()))||(null==(t=null==(a=e.partner)?void 0:a.email)?void 0:t.toLowerCase().includes(W.toLowerCase()))});return Q?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(v,{className:"w-12 h-12 animate-spin text-primary"})}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(a,{className:"glass-effect lg:col-span-1",children:[e.jsxs(t,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(i,{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5"}),"Messages",q.reduce((e,s)=>e+(s.unreadCount||0),0)>0&&e.jsxs(c,{variant:"destructive",className:"ml-2",children:[q.reduce((e,s)=>e+(s.unreadCount||0),0)," unread"]})]}),e.jsxs(o,{size:"sm",onClick:()=>V(!0),children:[e.jsx(_,{className:"w-4 h-4 mr-1"}),"New"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(w,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(m,{placeholder:"Search conversations...",value:W,onChange:e=>ee(e.target.value),className:"pl-10"})]})]}),e.jsx(n,{className:"p-0",children:e.jsx("div",{className:"max-h-[600px] overflow-y-auto",children:me.length>0?me.map(s=>{var r,a;return e.jsx("div",{onClick:()=>{z(s),ce(s),de(s)},className:"p-4 border-b border-border cursor-pointer hover:bg-muted/50 transition-colors "+((null==L?void 0:L.partnerId)===s.partnerId?"bg-muted":""),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:(null==(r=s.partner)?void 0:r.profile_picture_url)?e.jsx("img",{src:s.partner.profile_picture_url,alt:s.partner.full_name,className:"w-12 h-12 rounded-full object-cover"}):e.jsx(b,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:(null==(a=s.partner)?void 0:a.full_name)||"Unknown"}),e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0 ml-2",children:y(new Date(s.lastMessage.created_at),"MMM d")})]}),e.jsx("p",{className:"text-sm truncate "+(s.unreadCount>0?"font-semibold":"text-muted-foreground"),children:s.lastMessage.message_text}),s.unreadCount>0&&e.jsxs(c,{variant:"default",className:"mt-1",children:[s.unreadCount," new"]})]})]})},s.partnerId)}):e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx(N,{className:"w-12 h-12 mx-auto text-muted-foreground mb-3 opacity-50"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:W?"No conversations found":"No messages yet"}),e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>V(!0),className:"mt-3",children:[e.jsx(_,{className:"w-4 h-4 mr-1"}),"Start a conversation"]})]})})})]}),e.jsx(a,{className:"glass-effect lg:col-span-2",children:L?e.jsxs(e.Fragment,{children:[e.jsx(t,{className:"border-b border-border",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>z(null),className:"lg:hidden",children:e.jsx(C,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:(null==(E=L.partner)?void 0:E.profile_picture_url)?e.jsx("img",{src:L.partner.profile_picture_url,alt:L.partner.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(b,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:null==(k=L.partner)?void 0:k.full_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:null==(I=L.partner)?void 0:I.email})]})]})}),e.jsxs(n,{className:"p-0",children:[e.jsxs("div",{className:"h-[450px] overflow-y-auto p-4",children:[R.map(s=>{var r,a;const t=s.sender_id===M.id;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:"max-w-[70%] "+(t?"order-2":"order-1"),children:[!t&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center",children:(null==(r=s.sender)?void 0:r.profile_picture_url)?e.jsx("img",{src:s.sender.profile_picture_url,alt:s.sender.full_name,className:"w-6 h-6 rounded-full object-cover"}):e.jsx(b,{className:"w-3 h-3 text-primary"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:null==(a=s.sender)?void 0:a.full_name})]}),e.jsxs("div",{className:"rounded-lg p-3 "+(t?"bg-primary text-primary-foreground":"bg-muted"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:s.message_text}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1 "+(t?"text-primary-foreground/70":"text-muted-foreground"),children:[e.jsx("span",{className:"text-xs",children:y(new Date(s.created_at),"h:mm a")}),t&&(s.is_read?e.jsx(A,{className:"w-3 h-3"}):e.jsx(A,{className:"w-3 h-3 opacity-50"}))]})]})]})},s.id)}),e.jsx("div",{ref:se})]}),e.jsxs("div",{className:"border-t border-border p-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{placeholder:"Type your message...",value:$,onChange:e=>D(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),oe())},className:"min-h-[60px] resize-none"}),e.jsx(o,{onClick:oe,disabled:!$.trim()||G,size:"icon",children:G?e.jsx(v,{className:"w-4 h-4 animate-spin"}):e.jsx(S,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Press Enter to send, Shift+Enter for new line"})]})]})]}):e.jsx(n,{className:"flex items-center justify-center h-[600px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(N,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No conversation selected"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Choose a conversation from the list or start a new one"}),e.jsxs(o,{onClick:()=>V(!0),children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"New Message"]})]})})}),e.jsx(p,{open:O,onOpenChange:V,children:e.jsxs(h,{className:"glass-effect",children:[e.jsx(f,{children:e.jsx(j,{children:"New Message"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"To:"}),e.jsxs("select",{value:X,onChange:e=>Y(e.target.value),className:"w-full px-3 py-2 bg-background border border-border rounded-md",children:[e.jsx("option",{value:"",children:"Select a nutritionist"}),J.map(s=>e.jsxs("option",{value:s.id,children:[s.full_name," (",s.email,")"]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Message:"}),e.jsx(u,{value:Z,onChange:e=>K(e.target.value),placeholder:"Type your message here...",rows:6})]})]}),e.jsxs(g,{children:[e.jsx(o,{variant:"outline",onClick:()=>V(!1),children:"Cancel"}),e.jsx(o,{onClick:async()=>{if(X&&Z.trim()){H(!0);try{const{error:e}=await d.from("messages").insert({sender_id:M.id,recipient_id:X,message_text:Z.trim(),is_read:!1});if(e)throw e;x({title:"Message sent",description:"Your message has been sent successfully"}),V(!1),Y(""),K(""),ne()}catch(e){x({title:"Error",description:"Failed to send message",variant:"destructive"})}finally{H(!1)}}else x({title:"Error",description:"Please select a nutritionist and enter a message",variant:"destructive"})},disabled:G,children:G?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"Send Message"]})})]})]})})]})};export{E as default};
