import{r as e}from"./vendor-react-c35372bd.js";import{a as t,s as a}from"./index-6b8dec48.js";const r=r=>{const{user:n,profile:c}=t(),[o,i]=e.useState(null),[s,l]=e.useState(null),[u,d]=e.useState("disconnected"),[m,f]=e.useState(!1),[g,h]=e.useState(!0),[p,v]=e.useState(!1),[w,y]=e.useState(null),[k,S]=e.useState([]),[b,C]=e.useState("good"),R=e.useRef(null),T=e.useRef(null),E=e.useRef(null),D=e.useRef(null),j=e.useRef(null),M=e.useRef(null),O=e.useRef(0),x={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.voip.eutelia.it:3478"}],iceCandidatePoolSize:10},P=e.useCallback((e="high")=>{const t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),a={high:{width:{ideal:t?1280:1920,max:1920},height:{ideal:t?720:1080,max:1080},frameRate:{ideal:30,max:30},facingMode:"user"},medium:{width:{ideal:640,max:1280},height:{ideal:480,max:720},frameRate:{ideal:24,max:30},facingMode:"user"},low:{width:{ideal:320,max:640},height:{ideal:240,max:480},frameRate:{ideal:15,max:24},facingMode:"user"}};return a[e]||a.high},[]),V=e.useCallback(async(e=!0,t=!0)=>{try{y(null);let r=null;const n=["high","medium","low"];for(const c of n)try{const a=!!e&&P(c);r=await navigator.mediaDevices.getUserMedia({video:a,audio:!!t&&{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3,channelCount:1}}),C("high"===c?"good":"medium"===c?"medium":"poor");break}catch(a){if("low"===c)throw a}return r||(r=await navigator.mediaDevices.getUserMedia({video:!1,audio:t}),h(!1)),i(r),h(e&&r.getVideoTracks().length>0),f(!t),T.current&&(T.current.srcObject=r),r}catch(a){let e="Could not access camera/microphone.";throw"NotAllowedError"===a.name||"PermissionDeniedError"===a.name?e="Camera/microphone permission denied. Please allow access in your browser settings.":"NotFoundError"===a.name||"DevicesNotFoundError"===a.name?e="No camera or microphone found. Please connect a device.":"NotReadableError"===a.name||"TrackStartError"===a.name?e="Camera/microphone is already in use by another application.":"OverconstrainedError"===a.name&&(e="Camera does not support the requested resolution."),y(e),new Error(e)}},[P]),A=e.useCallback(e=>{const t=new RTCPeerConnection(x);return e&&e.getTracks().forEach(a=>{t.addTrack(a,e)}),t.ontrack=e=>{const[t]=e.streams;l(t),E.current&&(E.current.srcObject=t)},t.onicecandidate=async e=>{if(e.candidate&&D.current)try{await D.current.send({type:"broadcast",event:"ice-candidate",payload:{candidate:e.candidate.toJSON(),from:null==n?void 0:n.id}})}catch(t){}},t.onicegatheringstatechange=()=>{},t.onconnectionstatechange=()=>{d(t.connectionState),"failed"===t.connectionState?O.current<3?(O.current++,t.restartIce()):y("Connection failed after multiple attempts. Please try again."):"connected"===t.connectionState&&(O.current=0,y(null))},t.oniceconnectionstatechange=()=>{"disconnected"===t.iceConnectionState||"failed"===t.iceConnectionState&&t.restartIce()},R.current=t,t},[null==n?void 0:n.id]),N=e.useCallback(async()=>{if(r&&(null==n?void 0:n.id)){d("connecting"),y(null),O.current=0;try{const e=await V(),t=(A(e),a.channel(`video-call:${r}`,{config:{presence:{key:n.id},broadcast:{self:!1}}}));D.current=t,t.on("presence",{event:"sync"},()=>{const e=t.presenceState(),a=Object.keys(e).map(t=>({id:t,...e[t][0]}));S(a)}),t.on("presence",{event:"join"},async({key:e,newPresences:a})=>{if(e!==n.id&&R.current)try{const a=await R.current.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});await R.current.setLocalDescription(a),t.send({type:"broadcast",event:"offer",payload:{offer:R.current.localDescription.toJSON(),from:n.id,to:e}})}catch(r){}}),t.on("presence",{event:"leave"},({key:e})=>{s&&(s.getTracks().forEach(e=>e.stop()),l(null))}),t.on("broadcast",{event:"offer"},async({payload:e})=>{if(e.to===n.id&&R.current)try{await R.current.setRemoteDescription(new RTCSessionDescription(e.offer));const a=await R.current.createAnswer();await R.current.setLocalDescription(a),t.send({type:"broadcast",event:"answer",payload:{answer:R.current.localDescription.toJSON(),from:n.id,to:e.from}})}catch(a){}}),t.on("broadcast",{event:"answer"},async({payload:e})=>{if(e.to===n.id&&R.current)try{await R.current.setRemoteDescription(new RTCSessionDescription(e.answer))}catch(t){}}),t.on("broadcast",{event:"ice-candidate"},async({payload:e})=>{if(e.from!==n.id&&R.current)try{e.candidate&&await R.current.addIceCandidate(new RTCIceCandidate(e.candidate))}catch(t){}}),await t.subscribe(async e=>{"SUBSCRIBED"===e&&await t.track({name:(null==c?void 0:c.full_name)||"Anonymous",joinedAt:(new Date).toISOString()})})}catch(e){y(e.message||"Failed to join call"),d("failed")}}else y("Room ID and user authentication required")},[r,null==n?void 0:n.id,null==c?void 0:c.full_name,V,A]),I=e.useCallback(async()=>{if(o&&(o.getTracks().forEach(e=>{e.stop(),e.enabled=!1}),i(null)),s&&(s.getTracks().forEach(e=>{e.stop(),e.enabled=!1}),l(null)),j.current&&(j.current.getTracks().forEach(e=>e.stop()),j.current=null),T.current&&(T.current.srcObject=null),E.current&&(E.current.srcObject=null),R.current&&(R.current.close(),R.current=null),D.current){try{await a.removeChannel(D.current)}catch(e){}D.current=null}d("disconnected"),S([]),v(!1),f(!1),h(!0),y(null),C("good"),M.current=null,O.current=0},[o,s]),U=e.useCallback(()=>{if(o){o.getAudioTracks().forEach(e=>{e.enabled=!e.enabled}),f(!m)}},[o,m]),F=e.useCallback(()=>{if(o){o.getVideoTracks().forEach(e=>{e.enabled=!e.enabled}),h(!g)}},[o,g]),J=e.useCallback(async()=>{if(!o)return;const e=o.getVideoTracks()[0];if(e)try{const t="user"===e.getSettings().facingMode?"environment":"user",a=(await navigator.mediaDevices.getUserMedia({video:{facingMode:t},audio:!1})).getVideoTracks()[0];if(o.removeTrack(e),o.addTrack(a),e.stop(),R.current){const e=R.current.getSenders().find(e=>{var t;return"video"===(null==(t=e.track)?void 0:t.kind)});e&&await e.replaceTrack(a)}T.current&&(T.current.srcObject=o)}catch(t){y("Could not switch camera")}},[o]),q=e.useCallback(async()=>{if(R.current)if(p){if(j.current&&(j.current.getTracks().forEach(e=>e.stop()),j.current=null),M.current&&R.current){const e=R.current.getSenders().find(e=>{var t;return"video"===(null==(t=e.track)?void 0:t.kind)});e&&await e.replaceTrack(M.current)}v(!1)}else try{const e=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!1});if(j.current=e,o){const e=o.getVideoTracks();e.length>0&&(M.current=e[0])}const t=e.getVideoTracks()[0],a=R.current.getSenders().find(e=>{var t;return"video"===(null==(t=e.track)?void 0:t.kind)});a&&await a.replaceTrack(t),t.onended=()=>{q()},v(!0)}catch(e){"AbortError"!==e.name&&y("Could not share screen. Please check permissions.")}},[p,o]);return e.useEffect(()=>()=>{I()},[]),{localStream:o,remoteStream:s,connectionState:u,isMuted:m,isVideoEnabled:g,isScreenSharing:p,error:w,participants:k,callQuality:b,localVideoRef:T,remoteVideoRef:E,joinRoom:N,leaveRoom:I,toggleMute:U,toggleVideo:F,toggleScreenShare:q,switchCamera:J,initializeMedia:V}};export{r as u};
