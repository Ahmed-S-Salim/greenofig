import{j as e}from"./vendor-ui-1f4695e3.js";import{r as s}from"./vendor-react-c35372bd.js";import{u as t,a,D as r,b as n,d as l,e as i,f as o,B as d,T as c,I as m,s as u}from"./index-6b8dec48.js";import"./card-337a2a4f.js";import{l as x,X as h,a6 as g,F as p,au as f,an as v,b9 as j,L as b,aA as N,h as y}from"./vendor-utils-a892ab91.js";const w=({value:t,onChange:a,label:r,required:n,isRTL:l})=>{const i=s.useRef(null),[o,c]=s.useState(!1);s.useEffect(()=>{const e=i.current,s=e.getContext("2d");if(s.fillStyle="rgba(255,255,255,0.9)",s.fillRect(0,0,e.width,e.height),s.strokeStyle="var(--foreground)",s.lineWidth=2,s.lineCap="round",t){const e=new Image;e.onload=()=>s.drawImage(e,0,0),e.src=t}},[]);const m=e=>{var s,t,a,r;const n=i.current,l=n.getBoundingClientRect(),o=n.getContext("2d"),d=(e.clientX||(null==(t=null==(s=e.touches)?void 0:s[0])?void 0:t.clientX))-l.left,m=(e.clientY||(null==(r=null==(a=e.touches)?void 0:a[0])?void 0:r.clientY))-l.top;o.beginPath(),o.moveTo(d,m),c(!0)},u=e=>{var s,t,a,r;if(!o)return;const n=i.current,l=n.getBoundingClientRect(),d=n.getContext("2d"),c=(e.clientX||(null==(t=null==(s=e.touches)?void 0:s[0])?void 0:t.clientX))-l.left,m=(e.clientY||(null==(r=null==(a=e.touches)?void 0:a[0])?void 0:r.clientY))-l.top;d.lineTo(c,m),d.stroke()},x=()=>{if(o){c(!1);const e=i.current;a(e.toDataURL())}};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-foreground",children:[r," ",n&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx("div",{className:"border-2 border-border rounded-xl overflow-hidden bg-card/50 backdrop-blur-sm",children:e.jsx("canvas",{ref:i,width:400,height:150,className:"w-full touch-none cursor-crosshair",onMouseDown:m,onMouseMove:u,onMouseUp:x,onMouseLeave:x,onTouchStart:m,onTouchMove:u,onTouchEnd:x})}),e.jsx(d,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e=i.current,s=e.getContext("2d");s.fillStyle="rgba(255,255,255,0.9)",s.fillRect(0,0,e.width,e.height),a("")},className:"text-xs",children:l?"مسح التوقيع":"Clear Signature"})]})},C=({question:s,value:t,onChange:a,language:r})=>{var n;const l="ar"===r&&s.label_ar||s.label,i="ar"===r,o={id:s.id,value:t||"",onChange:e=>a(s.id,e.target.value),required:s.required,className:"w-full bg-card/50 border-border/50 focus:border-primary "+(i?"text-right":"text-left"),dir:i?"rtl":"ltr"};switch(s.type){case"text":case"tel":case"email":return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{htmlFor:s.id,className:"block text-sm font-medium text-foreground",children:[l," ",s.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(m,{type:s.type,...o})]});case"number":return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{htmlFor:s.id,className:"block text-sm font-medium text-foreground",children:[l," ",s.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(m,{type:"number",...o,min:"0",max:"150"})]});case"date":return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{htmlFor:s.id,className:"block text-sm font-medium text-foreground",children:[l," ",s.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(m,{type:"date",...o})]});case"textarea":return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{htmlFor:s.id,className:"block text-sm font-medium text-foreground",children:[l," ",s.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(c,{...o,rows:3})]});case"yesno":return e.jsxs("div",{className:"flex items-center justify-between p-3 sm:p-4 glass-effect rounded-xl border border-border/30",children:[e.jsxs("span",{className:"text-sm text-foreground flex-1 pr-4",children:[l," ",s.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{type:"button",size:"sm",variant:!0===t?"default":"outline",className:"min-w-[60px] "+(!0===t?"bg-primary hover:bg-primary/90 text-primary-foreground":"hover:bg-primary/10"),onClick:()=>a(s.id,!0),children:"ar"===r?"نعم":"Yes"}),e.jsx(d,{type:"button",size:"sm",variant:!1===t?"default":"outline",className:"min-w-[60px] "+(!1===t?"bg-destructive hover:bg-destructive/90 text-destructive-foreground":"hover:bg-destructive/10"),onClick:()=>a(s.id,!1),children:"ar"===r?"لا":"No"})]})]});case"select":return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{htmlFor:s.id,className:"block text-sm font-medium text-foreground",children:[l," ",s.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{...o,className:"w-full p-2.5 bg-card/50 border border-border/50 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent text-foreground transition-all",children:[e.jsx("option",{value:"",children:"ar"===r?"اختر...":"Select..."}),null==(n=s.options)?void 0:n.map(s=>e.jsx("option",{value:s.value,children:"ar"===r&&s.label_ar||s.label},s.value))]})]});case"signature":return e.jsx(w,{value:t,onChange:e=>a(s.id,e),label:l,required:s.required,isRTL:i});case"medication_list":return e.jsx(S,{value:t||[],onChange:e=>a(s.id,e),label:l,language:r});default:return null}},S=({value:t,onChange:a,label:r,language:n})=>{const[l,i]=s.useState(t||[]),o="ar"===n,c=(e,s,t)=>{const r=[...l];r[e][s]=t,i(r),a(r)};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium text-foreground",children:r}),l.map((s,t)=>e.jsxs("div",{className:"flex gap-2 items-center p-2 glass-effect rounded-lg",children:[e.jsx(m,{placeholder:o?"اسم الدواء":"Medication name",value:s.name,onChange:e=>c(t,"name",e.target.value),className:"flex-1 bg-card/50"}),e.jsx(m,{placeholder:o?"الجرعة":"Dosage",value:s.dosage,onChange:e=>c(t,"dosage",e.target.value),className:"w-24 bg-card/50"}),e.jsx(m,{placeholder:o?"الحالة":"Condition",value:s.condition,onChange:e=>c(t,"condition",e.target.value),className:"flex-1 bg-card/50"}),e.jsx(d,{type:"button",variant:"ghost",size:"icon",onClick:()=>(e=>{const s=l.filter((s,t)=>t!==e);i(s),a(s)})(t),className:"hover:bg-destructive/10",children:e.jsx(h,{className:"w-4 h-4 text-destructive"})})]},t)),e.jsx(d,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e=[...l,{name:"",dosage:"",condition:""}];i(e),a(e)},className:"hover:bg-primary/10",children:o?"+ إضافة دواء":"+ Add Medication"})]})};function _({assignmentId:c,formTemplate:m,onComplete:w,onClose:S,readOnly:_=!1,existingResponses:k=null,isModal:q=!1}){const{t:D,i18n:I}=t(),{user:M}=a(),T=I.language,O="ar"===T,[R,z]=s.useState(0),[F,L]=s.useState(k||{}),[Y,P]=s.useState(!1),[X,B]=s.useState(!1),[E,A]=s.useState({}),U=(null==m?void 0:m.sections)||[],W=U[R],G=R===U.length-1,H=0===R,J=(e,s)=>{_||(L(t=>({...t,[e]:s})),E[e]&&A(s=>({...s,[e]:null})))},K=()=>{const e={};return W.questions.forEach(s=>{if(s.required){const t=F[s.id];null!=t&&""!==t||(e[s.id]=!0)}}),A(e),0===Object.keys(e).length},Q=()=>{K()&&z(e=>e+1)},V=()=>{z(e=>e-1)},Z=async()=>{B(!0);try{await u.from("form_assignments").update({status:"in_progress",updated_at:(new Date).toISOString()}).eq("id",c);const{error:e}=await u.from("form_responses").upsert({assignment_id:c,client_id:M.id,responses:F,updated_at:(new Date).toISOString()},{onConflict:"assignment_id"});if(e)throw e}catch(e){}finally{B(!1)}},$=async()=>{if(K()){P(!0);try{const{error:e}=await u.from("form_responses").upsert({assignment_id:c,client_id:M.id,responses:F,signed_at:F.signature?(new Date).toISOString():null,signature_data:F.signature||null,updated_at:(new Date).toISOString()},{onConflict:"assignment_id"});if(e)throw e;const{error:s}=await u.from("form_assignments").update({status:"submitted",submitted_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}).eq("id",c);if(s)throw s;null==w||w()}catch(e){}finally{P(!1)}}},ee=e=>{if(!e.conditional)return!0;const{field:s,value:t}=e.conditional;return F[s]===t},se=O&&(null==m?void 0:m.name_ar)||(null==m?void 0:m.name),te=O&&(null==W?void 0:W.title_ar)||(null==W?void 0:W.title),ae=()=>e.jsxs("div",{className:""+(O?"rtl":"ltr"),dir:O?"rtl":"ltr",children:[e.jsxs("div",{className:"space-y-2 mb-6",children:[e.jsxs("div",{className:"flex justify-between text-sm text-text-secondary",children:[e.jsxs("span",{children:[O?"القسم":"Section"," ",R+1," / ",U.length]}),e.jsxs("span",{children:[Math.round((R+1)/U.length*100),"%"]})]}),e.jsx("div",{className:"w-full bg-muted rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"bg-gradient-to-r from-primary to-green-400 h-2 rounded-full transition-all duration-500 ease-out",style:{width:(R+1)/U.length*100+"%"}})})]}),e.jsx("div",{className:"flex gap-2 mb-6 overflow-x-auto pb-2 custom-scrollbar",children:U.map((s,t)=>e.jsxs("button",{onClick:()=>z(t),className:"px-3 py-1.5 rounded-full text-xs sm:text-sm whitespace-nowrap transition-all duration-200 font-medium "+(t===R?"bg-gradient-to-r from-primary to-green-400 text-primary-foreground shadow-lg":t<R?"bg-primary/20 text-primary":"bg-muted text-muted-foreground hover:bg-muted/80"),children:[t<R&&e.jsx(g,{className:"w-3 h-3 inline mr-1"}),O&&s.title_ar||s.title]},s.id))}),e.jsxs("div",{className:"glass-effect rounded-2xl p-4 sm:p-6 border border-border/30 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4 pb-4 border-b border-border/30",children:[e.jsx("div",{className:"p-2 rounded-xl bg-primary/10",children:e.jsx(p,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:te}),(null==W?void 0:W.description)&&e.jsx("p",{className:"text-sm text-text-secondary mt-0.5",children:O&&W.description_ar||W.description})]})]}),e.jsx("div",{className:"space-y-4",children:null==W?void 0:W.questions.filter(ee).map(s=>e.jsxs("div",{className:E[s.id]?"ring-2 ring-destructive rounded-xl p-3 -m-1 bg-destructive/5":"",children:[e.jsx(C,{question:s,value:F[s.id],onChange:J,language:T}),E[s.id]&&e.jsxs("p",{className:"text-destructive text-xs mt-1.5 flex items-center gap-1",children:[e.jsx(f,{className:"w-3 h-3"}),O?"هذا الحقل مطلوب":"This field is required"]})]},s.id))})]}),!_&&e.jsxs("div",{className:"flex items-center justify-between gap-3 pt-4 border-t border-border/30",children:[e.jsxs(d,{variant:"outline",onClick:V,disabled:H,className:"flex items-center gap-2 min-h-[44px]",children:[O?e.jsx(v,{className:"w-4 h-4"}):e.jsx(j,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:O?"السابق":"Previous"})]}),e.jsxs(d,{variant:"ghost",onClick:Z,disabled:X,className:"flex items-center gap-2 text-text-secondary hover:text-foreground",children:[X?e.jsx(b,{className:"w-4 h-4 animate-spin"}):e.jsx(N,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:O?"حفظ المسودة":"Save Draft"})]}),G?e.jsxs(d,{onClick:$,disabled:Y,className:"bg-gradient-to-r from-primary to-green-400 hover:opacity-90 text-primary-foreground flex items-center gap-2 min-h-[44px] shadow-lg",children:[Y?e.jsx(b,{className:"w-4 h-4 animate-spin"}):e.jsx(y,{className:"w-4 h-4"}),O?"إرسال":"Submit"]}):e.jsxs(d,{onClick:Q,className:"bg-gradient-to-r from-primary to-green-400 hover:opacity-90 text-primary-foreground flex items-center gap-2 min-h-[44px] shadow-lg",children:[e.jsx("span",{className:"hidden sm:inline",children:O?"التالي":"Next"}),O?e.jsx(j,{className:"w-4 h-4"}):e.jsx(v,{className:"w-4 h-4"})]})]})]});return q?e.jsx(r,{open:!0,onOpenChange:()=>null==S?void 0:S(),children:e.jsxs(n,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(l,{children:[e.jsxs(i,{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-xl bg-primary/10",children:e.jsx(x,{className:"w-6 h-6 text-primary"})}),se]}),e.jsx(o,{children:O?"يرجى ملء جميع الحقول المطلوبة أدناه":"Please fill out all required fields below"})]}),e.jsx(ae,{})]})}):e.jsxs("div",{className:"max-w-3xl mx-auto p-4 sm:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-2xl bg-primary/10",children:e.jsx(x,{className:"w-7 h-7 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-foreground",children:se}),e.jsx("p",{className:"text-sm text-text-secondary",children:O?"يرجى ملء جميع الحقول المطلوبة":"Please fill out all required fields"})]})]}),S&&e.jsx(d,{variant:"ghost",size:"icon",onClick:S,className:"rounded-full hover:bg-muted",children:e.jsx(h,{className:"w-5 h-5"})})]}),e.jsx(ae,{})]})}export{_ as C};
