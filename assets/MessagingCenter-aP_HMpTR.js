var __async=(e,s,t)=>new Promise((r,a)=>{var fulfilled=e=>{try{step(t.next(e))}catch(s){a(s)}},rejected=e=>{try{step(t.throw(e))}catch(s){a(s)}},step=e=>e.done?r(e.value):Promise.resolve(e.value).then(fulfilled,rejected);step((t=t.apply(e,s)).next())});import{j as e}from"./vendor-ui-gkPPHEPH.js";import{a as s}from"./vendor-react-Dds8VpLH.js";import{C as t,a as r,b as a,c as i}from"./card-Pj_OUEuM.js";import{u as n,s as l,B as c,T as o,t as d}from"./index-CKU5P2TY.js";import{I as m}from"./input-EoRmzMlo.js";import{S as u,a as x,b as f,c as h,d as p}from"./select-BoESt1cj.js";import{D as j,a as v,b as g,c as _,d as y}from"./dialog-D_VtZS95.js";import{t as N,ab as b,m as w,U as S,a5 as E,ac as C,h as D}from"./vendor-utils-CisQTPNT.js";import"./vendor-editor-DGqHsWbs.js";const MessagingCenter=()=>{var k,P;const{userProfile:q}=n(),[F,I]=s.useState([]),[L,T]=s.useState(null),[z,K]=s.useState([]),[M,O]=s.useState(""),[V,B]=s.useState(!1),[G,R]=s.useState([]),[U,Y]=s.useState(!1),[A,H]=s.useState(""),[J,Q]=s.useState(""),W=s.useRef(null);s.useEffect(()=>{(null==q?void 0:q.id)&&(fetchConversations(),fetchNutritionists())},[null==q?void 0:q.id]),s.useEffect(()=>{L&&(fetchMessages(),markAsRead())},[L]),s.useEffect(()=>{scrollToBottom()},[z]);const scrollToBottom=()=>{var e;null==(e=W.current)||e.scrollIntoView({behavior:"smooth"})},fetchNutritionists=()=>__async(null,null,function*(){try{const{data:e}=yield l.from("user_profiles").select("id, full_name, email, profile_picture_url").in("role",["nutritionist","admin","super_admin"]).order("full_name");R(e||[])}catch(e){console.error("Error fetching nutritionists:",e)}}),fetchConversations=()=>__async(null,null,function*(){try{const{data:e}=yield l.from("conversations").select("\n          *,\n          nutritionist:nutritionist_id (\n            id,\n            full_name,\n            email,\n            profile_picture_url\n          )\n        ").eq("user_id",q.id).order("last_message_at",{ascending:!1});I(e||[])}catch(e){console.error("Error fetching conversations:",e)}}),fetchMessages=()=>__async(null,null,function*(){try{const{data:e}=yield l.from("conversation_messages").select("\n          *,\n          sender:sender_id (\n            id,\n            full_name,\n            profile_picture_url\n          )\n        ").eq("conversation_id",L.id).order("created_at",{ascending:!0});K(e||[])}catch(e){console.error("Error fetching messages:",e)}}),markAsRead=()=>__async(null,null,function*(){try{yield l.rpc("mark_conversation_read",{p_conversation_id:L.id,p_user_id:q.id}),fetchConversations()}catch(e){console.error("Error marking as read:",e)}}),sendMessage=()=>__async(null,null,function*(){if(M.trim()){B(!0);try{const{error:e}=yield l.from("conversation_messages").insert({conversation_id:L.id,sender_id:q.id,sender_role:"user",message_text:M});if(e)throw e;O(""),fetchMessages(),fetchConversations(),d({title:"Message sent",description:"Your message has been sent successfully"})}catch(e){console.error("Error sending message:",e),d({title:"Error",description:"Failed to send message",variant:"destructive"})}finally{B(!1)}}});return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs(t,{className:"glass-effect lg:col-span-1",children:[e.jsx(r,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(a,{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5"}),"Messages"]}),e.jsxs(j,{open:U,onOpenChange:Y,children:[e.jsx(v,{asChild:!0,children:e.jsxs(c,{size:"sm",children:[e.jsx(b,{className:"w-4 h-4 mr-1"}),"New"]})}),e.jsxs(g,{children:[e.jsx(_,{children:e.jsx(y,{children:"Start New Conversation"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Professional"}),e.jsxs(u,{value:A,onValueChange:H,children:[e.jsx(x,{children:e.jsx(f,{placeholder:"Choose a nutritionist or admin"})}),e.jsx(h,{children:G.map(s=>e.jsxs(p,{value:s.id,children:[s.full_name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Subject (Optional)"}),e.jsx(m,{value:J,onChange:e=>Q(e.target.value),placeholder:"e.g., Diet plan question"})]}),e.jsx(c,{onClick:()=>__async(null,null,function*(){if(A){B(!0);try{const{data:e,error:s}=yield l.from("conversations").insert({user_id:q.id,nutritionist_id:A,subject:J||"General Inquiry"}).select().single();if(s)throw s;Y(!1),H(""),Q(""),fetchConversations(),d({title:"Success",description:"Conversation created successfully"})}catch(e){console.error("Error creating conversation:",e),d({title:"Error",description:"Failed to create conversation",variant:"destructive"})}finally{B(!1)}}else d({title:"Error",description:"Please select a nutritionist",variant:"destructive"})}),disabled:V,className:"w-full",children:"Start Conversation"})]})]})]})]})}),e.jsx(i,{className:"p-0",children:e.jsx("div",{className:"divide-y max-h-[calc(100vh-300px)] overflow-y-auto",children:0===F.length?e.jsxs("div",{className:"p-8 text-center text-muted-foreground",children:[e.jsx(N,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start a new conversation to get help from our nutritionists"})]}):F.map(s=>{var t,r;return e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},className:"p-4 cursor-pointer hover:bg-muted/50 transition-colors "+((null==L?void 0:L.id)===s.id?"bg-muted":""),onClick:()=>T(s),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0",children:(null==(t=s.nutritionist)?void 0:t.profile_picture_url)?e.jsx("img",{src:s.nutritionist.profile_picture_url,alt:s.nutritionist.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(S,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold truncate",children:null==(r=s.nutritionist)?void 0:r.full_name}),s.unread_by_user>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s.unread_by_user})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mt-1",children:s.last_message_preview||"No messages yet"}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-1",children:[e.jsx(E,{className:"w-3 h-3"}),s.last_message_at?new Date(s.last_message_at).toLocaleDateString():new Date(s.created_at).toLocaleDateString()]})]})]})},s.id)})})})]}),e.jsx(t,{className:"glass-effect lg:col-span-2 flex flex-col",children:L?e.jsxs(e.Fragment,{children:[e.jsx(r,{className:"pb-3 border-b",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:(null==(k=L.nutritionist)?void 0:k.profile_picture_url)?e.jsx("img",{src:L.nutritionist.profile_picture_url,alt:L.nutritionist.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(S,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:null==(P=L.nutritionist)?void 0:P.full_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:L.subject})]})]})}),e.jsxs(i,{className:"flex-1 overflow-y-auto p-4 space-y-4 max-h-[calc(100vh-450px)]",children:[z.map(s=>e.jsx(w.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex "+(s.sender_id===q.id?"justify-end":"justify-start"),children:e.jsxs("div",{className:"max-w-[70%] rounded-lg p-3 "+(s.sender_id===q.id?"bg-primary text-primary-foreground":"bg-muted"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message_text}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-xs "+(s.sender_id===q.id?"text-primary-foreground/70":"text-muted-foreground"),children:[new Date(s.created_at).toLocaleTimeString(),s.sender_id===q.id&&s.is_read&&e.jsx(C,{className:"w-3 h-3 ml-1"})]})]})},s.id)),e.jsx("div",{ref:W})]}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{value:M,onChange:e=>O(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())},placeholder:"Type your message... (Press Enter to send)",rows:2,className:"flex-1"}),e.jsx(c,{onClick:sendMessage,disabled:V||!M.trim(),size:"icon",className:"self-end",children:e.jsx(D,{className:"w-4 h-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(N,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"Select a conversation to start messaging"}),e.jsx("p",{className:"text-sm mt-2",children:"or create a new conversation to get started"})]})})})]})};export{MessagingCenter as default};
