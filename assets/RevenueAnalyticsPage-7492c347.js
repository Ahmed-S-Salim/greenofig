import{j as e}from"./vendor-ui-fc6158c5.js";import{r as s}from"./vendor-react-c35372bd.js";import{C as a}from"./card-aef3fa8a.js";import{T as t,a as r,b as l,c as n}from"./tabs-9cefe97b.js";import{s as i,B as c}from"./index-05318a06.js";import{at as o,a9 as d,aA as m,aL as x,T as u,l as h,_ as p,ab as v,aB as j,ad as y,ae as f,af as b,ag as g,aC as N,aH as w,aI as R,aJ as _,q as $,bA as F,bB as C}from"./vendor-utils-1c344488.js";import"./vendor-editor-c22fa4d3.js";const S=()=>{const[S,M]=s.useState(!0),[A,k]=s.useState("month"),[D,P]=s.useState({mrr:0,arr:0,totalRevenue:0,activeCustomers:0,churnRate:0,avgRevenuePerUser:0,lifetimeValue:0,revenueGrowth:0}),[T,O]=s.useState([]),[V,U]=s.useState([]),[G,L]=s.useState([]);s.useEffect(()=>{I()},[A]);const I=async()=>{M(!0);try{const e=new Date,s="week"===A?new Date(e.getTime()-6048e5):o(e,"month"===A?1:12),{data:a,error:t}=await i.from("payment_transactions").select("\n          *,\n          subscription_plans (name, price_monthly, price_yearly)\n        ").eq("status","succeeded").gte("created_at",s.toISOString()).order("created_at",{ascending:!1});if(t)throw t;const{data:r,error:l}=await i.from("user_subscriptions").select("\n          *,\n          subscription_plans (name, price_monthly, price_yearly)\n        ").eq("status","active");if(l)throw l;const n=a.reduce((e,s)=>e+parseFloat(s.amount),0),c=r.reduce((e,s)=>{var a,t;return"monthly"===s.billing_cycle?e+parseFloat((null==(a=s.subscription_plans)?void 0:a.price_monthly)||0):"yearly"===s.billing_cycle?e+parseFloat((null==(t=s.subscription_plans)?void 0:t.price_yearly)||0)/12:e},0),m=12*c,x=r.length,u=x>0?n/x:0,h=12*u,{data:p}=await i.from("user_subscriptions").select("id").eq("status","canceled").gte("canceled_at",o(e,1).toISOString()),v=x>0?((null==p?void 0:p.length)||0)/(x+((null==p?void 0:p.length)||0))*100:0,j=o(s,1),{data:y}=await i.from("payment_transactions").select("amount").eq("status","succeeded").gte("created_at",j.toISOString()).lt("created_at",s.toISOString()),f=(null==y?void 0:y.reduce((e,s)=>e+parseFloat(s.amount),0))||0;P({mrr:c,arr:m,totalRevenue:n,activeCustomers:x,churnRate:v,avgRevenuePerUser:u,lifetimeValue:h,revenueGrowth:f>0?(n-f)/f*100:0});const b={};a.forEach(e=>{const s=d(new Date(e.created_at),"MMM dd");b[s]=(b[s]||0)+parseFloat(e.amount)});const g=Object.entries(b).map(([e,s])=>({date:e,revenue:s.toFixed(2)}));O(g);const N={};r.forEach(e=>{var s,a,t;const r=(null==(s=e.subscription_plans)?void 0:s.name)||"Unknown",l="monthly"===e.billing_cycle?parseFloat((null==(a=e.subscription_plans)?void 0:a.price_monthly)||0):parseFloat((null==(t=e.subscription_plans)?void 0:t.price_yearly)||0)/12;N[r]=(N[r]||0)+l});const w=Object.entries(N).map(([e,s])=>({name:e,value:parseFloat(s.toFixed(2))}));U(w),L(a.slice(0,10))}catch(e){}finally{M(!1)}},E=["hsl(142, 76%, 36%)","hsl(217, 91%, 60%)","hsl(38, 92%, 50%)","hsl(0, 84%, 60%)","hsl(258, 90%, 66%)"],q=({title:s,value:t,icon:r,trend:l,trendValue:n,prefix:i="",suffix:c=""})=>e.jsx(a,{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-text-secondary mb-1",children:s}),e.jsxs("h3",{className:"text-3xl font-bold",children:[i,"number"==typeof t?t.toLocaleString(void 0,{maximumFractionDigits:2}):t,c]}),l&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-sm "+("up"===l?"text-primary":"text-destructive"),children:["up"===l?e.jsx(F,{className:"w-4 h-4"}):e.jsx(C,{className:"w-4 h-4"}),e.jsxs("span",{children:[n,"% vs last period"]})]})]}),e.jsx("div",{className:"p-3 bg-primary/10 rounded-lg",children:e.jsx(r,{className:"w-6 h-6 text-primary"})})]})});return S?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"})}):e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Revenue Analytics"}),e.jsx("p",{className:"text-text-secondary mt-1",children:"Track your revenue, subscriptions, and growth metrics"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>k("week"),className:"week"===A?"bg-primary text-primary-foreground":"",children:"Week"}),e.jsx(c,{variant:"outline",onClick:()=>k("month"),className:"month"===A?"bg-primary text-primary-foreground":"",children:"Month"}),e.jsx(c,{variant:"outline",onClick:()=>k("year"),className:"year"===A?"bg-primary text-primary-foreground":"",children:"Year"}),e.jsxs(c,{variant:"outline",onClick:()=>{const e=[["Revenue Analytics Export"],["Generated:",(new Date).toLocaleString()],[""],["Key Metrics"],["Metric","Value"],["Monthly Recurring Revenue",`$${D.mrr.toFixed(2)}`],["Annual Recurring Revenue",`$${D.arr.toFixed(2)}`],["Total Revenue",`$${D.totalRevenue.toFixed(2)}`],["Active Customers",D.activeCustomers],["Churn Rate",`${D.churnRate.toFixed(2)}%`],["Avg Revenue Per User",`$${D.avgRevenuePerUser.toFixed(2)}`],["Customer Lifetime Value",`$${D.lifetimeValue.toFixed(2)}`],["Revenue Growth",`${D.revenueGrowth.toFixed(2)}%`],[""],["Revenue by Plan"],["Plan","MRR"],...V.map(e=>[e.name,`$${e.value.toFixed(2)}`]),[""],["Recent Transactions"],["Date","Plan","Amount","Status","Transaction ID"],...G.map(e=>{var s;return[d(new Date(e.created_at),"MMM dd, yyyy"),(null==(s=e.subscription_plans)?void 0:s.name)||"N/A",`$${e.amount}`,e.status,e.payment_intent_id]})].map(e=>e.join(",")).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),t=URL.createObjectURL(s);a.setAttribute("href",t),a.setAttribute("download",`revenue-analytics-${d(new Date,"yyyy-MM-dd")}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},children:[e.jsx(m,{className:"w-4 h-4 mr-2"}),"Export CSV"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(q,{title:"Monthly Recurring Revenue",value:D.mrr,icon:x,prefix:"$",trend:D.revenueGrowth>0?"up":"down",trendValue:Math.abs(D.revenueGrowth).toFixed(1)}),e.jsx(q,{title:"Annual Recurring Revenue",value:D.arr,icon:u,prefix:"$"}),e.jsx(q,{title:"Active Customers",value:D.activeCustomers,icon:h}),e.jsx(q,{title:"Churn Rate",value:D.churnRate,icon:p,suffix:"%",trend:D.churnRate<5?"up":"down"})]}),e.jsxs(t,{defaultValue:"revenue",className:"space-y-6",children:[e.jsxs(r,{children:[e.jsx(l,{value:"revenue",children:"Revenue Trend"}),e.jsx(l,{value:"plans",children:"Plan Breakdown"}),e.jsx(l,{value:"transactions",children:"Recent Transactions"})]}),e.jsx(n,{value:"revenue",children:e.jsxs(a,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Revenue Over Time"}),e.jsx(v,{width:"100%",height:400,children:e.jsxs(j,{data:T,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorRevenue",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"hsl(var(--primary))",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"hsl(var(--primary))",stopOpacity:0})]})}),e.jsx(y,{strokeDasharray:"3 3"}),e.jsx(f,{dataKey:"date"}),e.jsx(b,{}),e.jsx(g,{formatter:e=>`$${e}`}),e.jsx(N,{type:"monotone",dataKey:"revenue",stroke:"hsl(var(--primary))",fillOpacity:1,fill:"url(#colorRevenue)"})]})})]})}),e.jsx(n,{value:"plans",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(a,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Revenue by Plan"}),e.jsx(v,{width:"100%",height:300,children:e.jsxs(w,{children:[e.jsx(R,{data:V,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percent:s})=>`${e}: ${(100*s).toFixed(0)}%`,outerRadius:100,fill:"hsl(217, 91%, 60%)",dataKey:"value",children:V.map((s,a)=>e.jsx(_,{fill:E[a%E.length]},`cell-${a}`))}),e.jsx(g,{formatter:e=>`$${e.toFixed(2)}`})]})})]}),e.jsxs(a,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Plan Statistics"}),e.jsx("div",{className:"space-y-4",children:V.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-4 h-4 rounded",style:{backgroundColor:E[a%E.length]}}),e.jsx("span",{className:"font-medium",children:s.name})]}),e.jsxs("span",{className:"text-lg font-bold",children:["$",s.value.toFixed(2),"/mo"]})]},a))})]})]})}),e.jsx(n,{value:"transactions",children:e.jsxs(a,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Recent Transactions"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left py-3 px-4",children:"Date"}),e.jsx("th",{className:"text-left py-3 px-4",children:"Plan"}),e.jsx("th",{className:"text-left py-3 px-4",children:"Amount"}),e.jsx("th",{className:"text-left py-3 px-4",children:"Status"}),e.jsx("th",{className:"text-left py-3 px-4",children:"Transaction ID"})]})}),e.jsx("tbody",{children:G.map(s=>{var a;return e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsx("td",{className:"py-3 px-4",children:d(new Date(s.created_at),"MMM dd, yyyy")}),e.jsx("td",{className:"py-3 px-4",children:(null==(a=s.subscription_plans)?void 0:a.name)||"N/A"}),e.jsxs("td",{className:"py-3 px-4 font-semibold",children:["$",s.amount]}),e.jsx("td",{className:"py-3 px-4",children:e.jsx("span",{className:"px-2 py-1 bg-primary/10 text-primary rounded-full text-xs",children:s.status})}),e.jsx("td",{className:"py-3 px-4 text-xs text-text-secondary",children:s.payment_intent_id})]},s.id)})})]})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(a,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(x,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold",children:"Avg Revenue Per User"})]}),e.jsxs("p",{className:"text-3xl font-bold",children:["$",D.avgRevenuePerUser.toFixed(2)]})]}),e.jsxs(a,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(u,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold",children:"Customer Lifetime Value"})]}),e.jsxs("p",{className:"text-3xl font-bold",children:["$",D.lifetimeValue.toFixed(2)]})]}),e.jsxs(a,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx($,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold",children:"Total Revenue"})]}),e.jsxs("p",{className:"text-3xl font-bold",children:["$",D.totalRevenue.toFixed(2)]})]})]})]})};export{S as default};
