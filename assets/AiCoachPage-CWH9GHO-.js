var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,__async=(e,t,s)=>new Promise((r,a)=>{var fulfilled=e=>{try{step(s.next(e))}catch(t){a(t)}},rejected=e=>{try{step(s.throw(e))}catch(t){a(t)}},step=e=>e.done?r(e.value):Promise.resolve(e.value).then(fulfilled,rejected);step((s=s.apply(e,t)).next())});import{j as n}from"./vendor-ui-gkPPHEPH.js";import{a as l}from"./vendor-react-Dds8VpLH.js";import{u as o,d as c,s as d,H as m,T as u,B as h}from"./index-CKU5P2TY.js";import{m as y,c as f,A as p,q as x,U as g,h as j}from"./vendor-utils-CisQTPNT.js";import"./vendor-editor-DGqHsWbs.js";const AiCoachPage=()=>{const{userProfile:e,user:v}=o(),{toast:b}=c(),[w,N]=l.useState([]),[k,_]=l.useState(""),[I,O]=l.useState(!1),[S,P]=l.useState(!0),C=l.useRef(null);l.useEffect(()=>{var e;null==(e=C.current)||e.scrollIntoView({behavior:"smooth"})},[w]);const D=l.useCallback(()=>__async(null,null,function*(){var t;if(v)try{P(!0);const{data:s,error:r}=yield d.from("ai_chat_messages").select("id, text, sender, created_at").eq("user_id",v.id).order("created_at",{ascending:!0});if(r)throw r;if(s&&s.length>0)N(s);else if(e){const s={id:Date.now(),text:`Hello ${(null==(t=null==e?void 0:e.full_name)?void 0:t.split(" ")[0])||"there"}! I'm your personal AI Health Coach. How can I help you achieve your wellness goals today?`,sender:"ai"};N([s])}}catch(s){b({variant:"destructive",title:"Error fetching history",description:"Could not load your previous conversation."})}finally{P(!1)}}),[v,e,b]);l.useEffect(()=>{D()},[D]);const handleSendMessage=(n,l)=>__async(null,null,function*(){n&&n.preventDefault();const o=l||k;if(!o.trim()||I)return;const c={text:o,sender:"user",user_id:v.id},m=(u=((e,t)=>{for(var s in t||(t={}))a.call(t,s)&&__defNormalProp(e,s,t[s]);if(r)for(var s of r(t))i.call(t,s)&&__defNormalProp(e,s,t[s]);return e})({},c),h={id:Date.now(),created_at:(new Date).toISOString()},t(u,s(h)));var u,h;const y=[...w,m];N(y),_(""),O(!0),yield d.from("ai_chat_messages").insert(c);try{const{data:t,error:s}=yield d.functions.invoke("ai-coach-memory",{body:JSON.stringify({messages:y.slice(-10),userProfile:e})});if(s)throw s;const r={text:t.reply,sender:"ai",user_id:v.id},{data:a,error:i}=yield d.from("ai_chat_messages").insert(r).select().single();if(i)throw i;N(e=>[...e.filter(e=>e.id!==m.id),m,a])}catch(f){const e={id:Date.now()+1,text:"Sorry, I'm having trouble connecting right now. Please try again in a moment.",sender:"ai"};N(t=>[...t,e])}finally{O(!1)}});return n.jsxs(n.Fragment,{children:[n.jsxs(m,{children:[n.jsx("title",{children:"AI Coach - GreenoFig"}),n.jsx("meta",{name:"description",content:"Chat with your personal AI health and wellness coach."})]}),n.jsxs(y.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col h-[calc(100vh-120px)]",children:[n.jsxs("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 space-y-6",children:[S&&n.jsx("div",{className:"flex justify-center items-center h-full",children:n.jsx(f,{className:"w-8 h-8 animate-spin text-primary"})}),n.jsx(p,{children:!S&&w.map(e=>n.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"flex items-end gap-3 "+("user"===e.sender?"justify-end":"justify-start"),children:["ai"===e.sender&&n.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:n.jsx(x,{className:"w-6 h-6 text-primary"})}),n.jsx("div",{className:"max-w-lg p-4 rounded-2xl shadow-md "+("user"===e.sender?"bg-primary text-primary-foreground rounded-br-none":"bg-muted text-foreground rounded-bl-none"),children:n.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.text})}),"user"===e.sender&&n.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-muted flex items-center justify-center",children:n.jsx(g,{className:"w-5 h-5 text-muted-foreground"})})]},e.id))}),I&&n.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-end gap-3 justify-start",children:[n.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:n.jsx(x,{className:"w-6 h-6 text-primary"})}),n.jsx("div",{className:"max-w-lg p-4 rounded-2xl shadow-md bg-muted text-foreground rounded-bl-none",children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(f,{className:"w-5 h-5 animate-spin"}),n.jsx("span",{className:"text-sm",children:"Thinking..."})]})})]}),n.jsx("div",{ref:C})]}),w.length<=1&&!I&&!S&&n.jsx("div",{className:"p-4 md:px-6",children:n.jsx("div",{className:"grid grid-cols-2 gap-3",children:["Give me a healthy breakfast idea.","Suggest a quick 15-minute workout.","How can I increase my energy levels?","What's a good way to de-stress?"].map((e,t)=>n.jsx(y.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1*t},onClick:t=>handleSendMessage(t,e),className:"p-3 bg-muted hover:bg-accent rounded-lg text-left text-sm",children:e},t))})}),n.jsx("div",{className:"p-4 md:p-6 border-t border-border bg-background",children:n.jsxs("form",{onSubmit:handleSendMessage,className:"relative",children:[n.jsx(u,{value:k,onChange:e=>_(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||handleSendMessage(e)},placeholder:"Ask your AI coach anything...",className:"w-full pr-20 py-3 resize-none bg-muted border-border",rows:1,disabled:I||S}),n.jsx(h,{type:"submit",size:"icon",className:"absolute right-3 top-1/2 -translate-y-1/2",disabled:I||S||!k.trim(),children:n.jsx(j,{className:"w-5 h-5"})})]})})]})]})};export{AiCoachPage as default};
