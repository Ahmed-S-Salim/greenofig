import{j as e}from"./vendor-ui-CAdTc8ma.js";import{a as s}from"./vendor-react-DYWoKpfz.js";import{C as t}from"./card-DObhyBOQ.js";import{T as a,a as l,b as r,c as n}from"./tabs-W0guYPUx.js";import{s as i,B as m}from"./index-AtoPiNTv.js";import{F as c,G as x,I as o,y as d,J as p,K as u,N as h,R as y,O as j,Q as f,X as v,Y as g,V as b,W as N,_ as w,$ as R,a0 as _,a1 as $,a2 as F,a3 as C}from"./vendor-utils-7_dm-8Ld.js";import"./vendor-editor-CURn2XBo.js";const S=()=>{const[S,M]=s.useState(!0),[k,A]=s.useState("month"),[D,P]=s.useState({mrr:0,arr:0,totalRevenue:0,activeCustomers:0,churnRate:0,avgRevenuePerUser:0,lifetimeValue:0,revenueGrowth:0}),[O,T]=s.useState([]),[V,G]=s.useState([]),[U,E]=s.useState([]);s.useEffect(()=>{I()},[k]);const I=async()=>{M(!0);try{const e=new Date,s="week"===k?new Date(e.getTime()-6048e5):c(e,"month"===k?1:12),{data:t,error:a}=await i.from("payment_transactions").select("\n          *,\n          subscription_plans (name, price_monthly, price_yearly)\n        ").eq("status","succeeded").gte("created_at",s.toISOString()).order("created_at",{ascending:!1});if(a)throw a;const{data:l,error:r}=await i.from("user_subscriptions").select("\n          *,\n          subscription_plans (name, price_monthly, price_yearly)\n        ").eq("status","active");if(r)throw r;const n=t.reduce((e,s)=>e+parseFloat(s.amount),0),m=l.reduce((e,s)=>"monthly"===s.billing_cycle?e+parseFloat(s.subscription_plans?.price_monthly||0):"yearly"===s.billing_cycle?e+parseFloat(s.subscription_plans?.price_yearly||0)/12:e,0),o=12*m,d=l.length,p=d>0?n/d:0,u=12*p,{data:h}=await i.from("user_subscriptions").select("id").eq("status","canceled").gte("canceled_at",c(e,1).toISOString()),y=d>0?(h?.length||0)/(d+(h?.length||0))*100:0,j=c(s,1),{data:f}=await i.from("payment_transactions").select("amount").eq("status","succeeded").gte("created_at",j.toISOString()).lt("created_at",s.toISOString()),v=f?.reduce((e,s)=>e+parseFloat(s.amount),0)||0;P({mrr:m,arr:o,totalRevenue:n,activeCustomers:d,churnRate:y,avgRevenuePerUser:p,lifetimeValue:u,revenueGrowth:v>0?(n-v)/v*100:0});const g={};t.forEach(e=>{const s=x(new Date(e.created_at),"MMM dd");g[s]=(g[s]||0)+parseFloat(e.amount)});const b=Object.entries(g).map(([e,s])=>({date:e,revenue:s.toFixed(2)}));T(b);const N={};l.forEach(e=>{const s=e.subscription_plans?.name||"Unknown",t="monthly"===e.billing_cycle?parseFloat(e.subscription_plans?.price_monthly||0):parseFloat(e.subscription_plans?.price_yearly||0)/12;N[s]=(N[s]||0)+t});const w=Object.entries(N).map(([e,s])=>({name:e,value:parseFloat(s.toFixed(2))}));G(w),E(t.slice(0,10))}catch(e){console.error("Error fetching analytics:",e)}finally{M(!1)}},L=["hsl(142, 76%, 36%)","hsl(217, 91%, 60%)","hsl(38, 92%, 50%)","hsl(0, 84%, 60%)","hsl(258, 90%, 66%)"],K=({title:s,value:a,icon:l,trend:r,trendValue:n,prefix:i="",suffix:m=""})=>e.jsx(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs sm:text-sm text-text-secondary mb-1",children:s}),e.jsxs("h3",{className:"text-2xl sm:text-3xl font-bold",children:[i,"number"==typeof a?a.toLocaleString(void 0,{maximumFractionDigits:2}):a,m]}),r&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-xs sm:text-sm "+("up"===r?"text-primary":"text-destructive"),children:["up"===r?e.jsx(F,{className:"w-3 h-3 sm:w-4 sm:h-4"}):e.jsx(C,{className:"w-3 h-3 sm:w-4 sm:h-4"}),e.jsxs("span",{children:[n,"% vs last period"]})]})]}),e.jsx("div",{className:"p-2 sm:p-3 bg-primary/10 rounded-lg",children:e.jsx(l,{className:"w-5 h-5 sm:w-6 sm:h-6 text-primary"})})]})});return S?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"})}):e.jsxs("div",{className:"min-h-screen px-2 sm:px-4 lg:px-6 py-4 sm:py-6 space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"text-center sm:text-left w-full sm:w-auto",children:[e.jsx("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold",children:"Revenue Analytics"}),e.jsx("p",{className:"text-sm sm:text-base text-text-secondary mt-1",children:"Track your revenue, subscriptions, and growth metrics"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center sm:justify-end gap-2 w-full sm:w-auto",children:[e.jsx(m,{variant:"outline",onClick:()=>A("week"),className:"h-9 px-3 text-sm "+("week"===k?"bg-primary text-primary-foreground":""),children:"Week"}),e.jsx(m,{variant:"outline",onClick:()=>A("month"),className:"h-9 px-3 text-sm "+("month"===k?"bg-primary text-primary-foreground":""),children:"Month"}),e.jsx(m,{variant:"outline",onClick:()=>A("year"),className:"h-9 px-3 text-sm "+("year"===k?"bg-primary text-primary-foreground":""),children:"Year"}),e.jsxs(m,{variant:"outline",onClick:()=>{const e=[["Revenue Analytics Export"],["Generated:",(new Date).toLocaleString()],[""],["Key Metrics"],["Metric","Value"],["Monthly Recurring Revenue",`$${D.mrr.toFixed(2)}`],["Annual Recurring Revenue",`$${D.arr.toFixed(2)}`],["Total Revenue",`$${D.totalRevenue.toFixed(2)}`],["Active Customers",D.activeCustomers],["Churn Rate",`${D.churnRate.toFixed(2)}%`],["Avg Revenue Per User",`$${D.avgRevenuePerUser.toFixed(2)}`],["Customer Lifetime Value",`$${D.lifetimeValue.toFixed(2)}`],["Revenue Growth",`${D.revenueGrowth.toFixed(2)}%`],[""],["Revenue by Plan"],["Plan","MRR"],...V.map(e=>[e.name,`$${e.value.toFixed(2)}`]),[""],["Recent Transactions"],["Date","Plan","Amount","Status","Transaction ID"],...U.map(e=>[x(new Date(e.created_at),"MMM dd, yyyy"),e.subscription_plans?.name||"N/A",`$${e.amount}`,e.status,e.payment_intent_id])].map(e=>e.join(",")).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),a=URL.createObjectURL(s);t.setAttribute("href",a),t.setAttribute("download",`revenue-analytics-${x(new Date,"yyyy-MM-dd")}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)},className:"h-9 px-3 text-sm",children:[e.jsx(o,{className:"w-4 h-4 mr-2"}),"Export CSV"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4",children:[e.jsx(K,{title:"Monthly Recurring Revenue",value:D.mrr,icon:d,prefix:"$",trend:D.revenueGrowth>0?"up":"down",trendValue:Math.abs(D.revenueGrowth).toFixed(1)}),e.jsx(K,{title:"Annual Recurring Revenue",value:D.arr,icon:p,prefix:"$"}),e.jsx(K,{title:"Active Customers",value:D.activeCustomers,icon:u}),e.jsx(K,{title:"Churn Rate",value:D.churnRate,icon:h,suffix:"%",trend:D.churnRate<5?"up":"down"})]}),e.jsxs(a,{defaultValue:"revenue",className:"space-y-4 sm:space-y-6",children:[e.jsxs(l,{className:"w-full sm:w-auto flex-wrap h-auto",children:[e.jsx(r,{value:"revenue",className:"text-xs sm:text-sm",children:"Revenue Trend"}),e.jsx(r,{value:"plans",className:"text-xs sm:text-sm",children:"Plan Breakdown"}),e.jsx(r,{value:"transactions",className:"text-xs sm:text-sm",children:"Recent Transactions"})]}),e.jsx(n,{value:"revenue",children:e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold mb-4",children:"Revenue Over Time"}),e.jsx("div",{className:"h-[300px] sm:h-[400px] w-full",children:e.jsx(y,{width:"100%",height:"100%",children:e.jsxs(j,{data:O,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorRevenue",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"hsl(var(--primary))",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"hsl(var(--primary))",stopOpacity:0})]})}),e.jsx(f,{strokeDasharray:"3 3"}),e.jsx(v,{dataKey:"date"}),e.jsx(g,{}),e.jsx(b,{formatter:e=>`$${e}`}),e.jsx(N,{type:"monotone",dataKey:"revenue",stroke:"hsl(var(--primary))",fillOpacity:1,fill:"url(#colorRevenue)"})]})})})]})}),e.jsx(n,{value:"plans",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-2 sm:gap-4",children:[e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold mb-4",children:"Revenue by Plan"}),e.jsx("div",{className:"h-[250px] sm:h-[300px] w-full",children:e.jsx(y,{width:"100%",height:"100%",children:e.jsxs(w,{children:[e.jsx(R,{data:V,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percent:s})=>`${e}: ${(100*s).toFixed(0)}%`,outerRadius:100,fill:"hsl(217, 91%, 60%)",dataKey:"value",children:V.map((s,t)=>e.jsx(_,{fill:L[t%L.length]},`cell-${t}`))}),e.jsx(b,{formatter:e=>`$${e.toFixed(2)}`})]})})})]}),e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold mb-4",children:"Plan Statistics"}),e.jsx("div",{className:"space-y-3 sm:space-y-4",children:V.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded flex-shrink-0",style:{backgroundColor:L[t%L.length]}}),e.jsx("span",{className:"text-sm sm:text-base font-medium",children:s.name})]}),e.jsxs("span",{className:"text-base sm:text-lg font-bold",children:["$",s.value.toFixed(2),"/mo"]})]},t))})]})]})}),e.jsx(n,{value:"transactions",children:e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold mb-4",children:"Recent Transactions"}),e.jsx("div",{className:"overflow-x-auto -mx-3 sm:mx-0",children:e.jsxs("table",{className:"w-full min-w-[640px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:"Date"}),e.jsx("th",{className:"text-left py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:"Plan"}),e.jsx("th",{className:"text-left py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:"Amount"}),e.jsx("th",{className:"text-left py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:"Status"}),e.jsx("th",{className:"text-left py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:"Transaction ID"})]})}),e.jsx("tbody",{children:U.map(s=>e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsx("td",{className:"py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:x(new Date(s.created_at),"MMM dd, yyyy")}),e.jsx("td",{className:"py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm",children:s.subscription_plans?.name||"N/A"}),e.jsxs("td",{className:"py-2 sm:py-3 px-2 sm:px-4 text-xs sm:text-sm font-semibold",children:["$",s.amount]}),e.jsx("td",{className:"py-2 sm:py-3 px-2 sm:px-4",children:e.jsx("span",{className:"px-2 py-1 bg-primary/10 text-primary rounded-full text-xs",children:s.status})}),e.jsx("td",{className:"py-2 sm:py-3 px-2 sm:px-4 text-xs text-text-secondary",children:s.payment_intent_id})]},s.id))})]})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-4",children:[e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4",children:[e.jsx(d,{className:"w-4 h-4 sm:w-5 sm:h-5 text-primary"}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold",children:"Avg Revenue Per User"})]}),e.jsxs("p",{className:"text-2xl sm:text-3xl font-bold",children:["$",D.avgRevenuePerUser.toFixed(2)]})]}),e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4",children:[e.jsx(p,{className:"w-4 h-4 sm:w-5 sm:h-5 text-primary"}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold",children:"Customer Lifetime Value"})]}),e.jsxs("p",{className:"text-2xl sm:text-3xl font-bold",children:["$",D.lifetimeValue.toFixed(2)]})]}),e.jsxs(t,{className:"p-3 sm:p-4 lg:p-6 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4",children:[e.jsx($,{className:"w-4 h-4 sm:w-5 sm:h-5 text-primary"}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold",children:"Total Revenue"})]}),e.jsxs("p",{className:"text-2xl sm:text-3xl font-bold",children:["$",D.totalRevenue.toFixed(2)]})]})]})]})};export{S as default};
