import{j as e}from"./vendor-ui-jbjsCjSW.js";import{a as s}from"./vendor-react-C4Yvcgue.js";import{C as t,a,b as r,c as i}from"./card-D1JrzjfW.js";import{u as n,s as l,B as c,T as d,t as o}from"./index-CJcmXEeE.js";import{I as m}from"./input-Bpymy_1X.js";import{S as u,a as x,b as f,c as h,d as p}from"./select-xVO_AqLS.js";import{D as j,a as g,b as v,c as _,d as N}from"./dialog-DQGKHfp4.js";import{t as y,ab as w,m as b,U as S,a5 as C,ac as D,h as E}from"./vendor-utils-jh41mPu7.js";import"./vendor-editor-D6Zd0gNL.js";const k=()=>{const{userProfile:k}=n(),[P,q]=s.useState([]),[F,I]=s.useState(null),[L,T]=s.useState([]),[z,K]=s.useState(""),[M,O]=s.useState(!1),[V,B]=s.useState([]),[G,R]=s.useState(!1),[U,Y]=s.useState(""),[A,H]=s.useState(""),J=s.useRef(null);s.useEffect(()=>{k?.id&&(X(),W())},[k?.id]),s.useEffect(()=>{F&&(Z(),$())},[F]),s.useEffect(()=>{Q()},[L]);const Q=()=>{J.current?.scrollIntoView({behavior:"smooth"})},W=async()=>{try{const{data:e}=await l.from("user_profiles").select("id, full_name, email, profile_picture_url").in("role",["nutritionist","admin","super_admin"]).order("full_name");B(e||[])}catch(e){}},X=async()=>{try{const{data:e}=await l.from("conversations").select("\n          *,\n          nutritionist:nutritionist_id (\n            id,\n            full_name,\n            email,\n            profile_picture_url\n          )\n        ").eq("user_id",k.id).order("last_message_at",{ascending:!1});q(e||[])}catch(e){}},Z=async()=>{try{const{data:e}=await l.from("conversation_messages").select("\n          *,\n          sender:sender_id (\n            id,\n            full_name,\n            profile_picture_url\n          )\n        ").eq("conversation_id",F.id).order("created_at",{ascending:!0});T(e||[])}catch(e){}},$=async()=>{try{await l.rpc("mark_conversation_read",{p_conversation_id:F.id,p_user_id:k.id}),X()}catch(e){}},ee=async()=>{if(z.trim()){O(!0);try{const{error:e}=await l.from("conversation_messages").insert({conversation_id:F.id,sender_id:k.id,sender_role:"user",message_text:z});if(e)throw e;K(""),Z(),X(),o({title:"Message sent",description:"Your message has been sent successfully"})}catch(e){o({title:"Error",description:"Failed to send message",variant:"destructive"})}finally{O(!1)}}};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs(t,{className:"glass-effect lg:col-span-1",children:[e.jsx(a,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(r,{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(y,{className:"w-5 h-5"}),"Messages"]}),e.jsxs(j,{open:G,onOpenChange:R,children:[e.jsx(g,{asChild:!0,children:e.jsxs(c,{size:"sm",children:[e.jsx(w,{className:"w-4 h-4 mr-1"}),"New"]})}),e.jsxs(v,{children:[e.jsx(_,{children:e.jsx(N,{children:"Start New Conversation"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Professional"}),e.jsxs(u,{value:U,onValueChange:Y,children:[e.jsx(x,{children:e.jsx(f,{placeholder:"Choose a nutritionist or admin"})}),e.jsx(h,{children:V.map(s=>e.jsxs(p,{value:s.id,children:[s.full_name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Subject (Optional)"}),e.jsx(m,{value:A,onChange:e=>H(e.target.value),placeholder:"e.g., Diet plan question"})]}),e.jsx(c,{onClick:async()=>{if(U){O(!0);try{const{data:e,error:s}=await l.from("conversations").insert({user_id:k.id,nutritionist_id:U,subject:A||"General Inquiry"}).select().single();if(s)throw s;R(!1),Y(""),H(""),X(),o({title:"Success",description:"Conversation created successfully"})}catch(e){o({title:"Error",description:"Failed to create conversation",variant:"destructive"})}finally{O(!1)}}else o({title:"Error",description:"Please select a nutritionist",variant:"destructive"})},disabled:M,className:"w-full",children:"Start Conversation"})]})]})]})]})}),e.jsx(i,{className:"p-0",children:e.jsx("div",{className:"divide-y max-h-[calc(100vh-300px)] overflow-y-auto",children:0===P.length?e.jsxs("div",{className:"p-8 text-center text-muted-foreground",children:[e.jsx(y,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start a new conversation to get help from our nutritionists"})]}):P.map(s=>e.jsx(b.div,{initial:{opacity:0},animate:{opacity:1},className:"p-4 cursor-pointer hover:bg-muted/50 transition-colors "+(F?.id===s.id?"bg-muted":""),onClick:()=>I(s),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0",children:s.nutritionist?.profile_picture_url?e.jsx("img",{src:s.nutritionist.profile_picture_url,alt:s.nutritionist.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(S,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold truncate",children:s.nutritionist?.full_name}),s.unread_by_user>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s.unread_by_user})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mt-1",children:s.last_message_preview||"No messages yet"}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-1",children:[e.jsx(C,{className:"w-3 h-3"}),s.last_message_at?new Date(s.last_message_at).toLocaleDateString():new Date(s.created_at).toLocaleDateString()]})]})]})},s.id))})})]}),e.jsx(t,{className:"glass-effect lg:col-span-2 flex flex-col",children:F?e.jsxs(e.Fragment,{children:[e.jsx(a,{className:"pb-3 border-b",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:F.nutritionist?.profile_picture_url?e.jsx("img",{src:F.nutritionist.profile_picture_url,alt:F.nutritionist.full_name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx(S,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:F.nutritionist?.full_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:F.subject})]})]})}),e.jsxs(i,{className:"flex-1 overflow-y-auto p-4 space-y-4 max-h-[calc(100vh-450px)]",children:[L.map(s=>e.jsx(b.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex "+(s.sender_id===k.id?"justify-end":"justify-start"),children:e.jsxs("div",{className:"max-w-[70%] rounded-lg p-3 "+(s.sender_id===k.id?"bg-primary text-primary-foreground":"bg-muted"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message_text}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-xs "+(s.sender_id===k.id?"text-primary-foreground/70":"text-muted-foreground"),children:[new Date(s.created_at).toLocaleTimeString(),s.sender_id===k.id&&s.is_read&&e.jsx(D,{className:"w-3 h-3 ml-1"})]})]})},s.id)),e.jsx("div",{ref:J})]}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{value:z,onChange:e=>K(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ee())},placeholder:"Type your message... (Press Enter to send)",rows:2,className:"flex-1"}),e.jsx(c,{onClick:ee,disabled:M||!z.trim(),size:"icon",className:"self-end",children:e.jsx(E,{className:"w-4 h-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"Select a conversation to start messaging"}),e.jsx("p",{className:"text-sm mt-2",children:"or create a new conversation to get started"})]})})})]})};export{k as default};
